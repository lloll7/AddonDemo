events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout 65;

    # 主服务器配置
    server {
        listen 3000;
        server_name 127.0.0.1;
        root /usr/share/nginx/html;
        index index.html index.htm;

        # 服务静态文件
        location / {
            try_files $uri $uri/ /index.html;
        }

        # API 代理 - 匹配您现有的前端请求模式
        # 前端请求: /api/device/thing → 后端接收: /device/thing
        location /api/ {
            proxy_pass http://127.0.0.1:3001/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 移除 /api 前缀，与您的 Vite 配置保持一致
            rewrite ^/api/(.*)$ /$1 break;
        }

        # WebSocket 支持 (如果需要)
        location /ws {
            proxy_pass http://127.0.0.1:3001;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # # SSE 支持
        # location /sse/ {
        #     proxy_pass http://127.0.0.1:3001;
        #     proxy_buffering off;
        #     proxy_cache off;
        #     proxy_set_header Connection '';
        #     proxy_http_version 1.1;
        #     chunked_transfer_encoding off;
        # }
    }
}